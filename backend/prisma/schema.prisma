generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Notification {
  id        Int                @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  data      Json?
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
}

model User {
  id                             Int                      @id @default(autoincrement())
  email                          String                   @unique
  password                       String
  role                           UserRole?                // Optional: only for FSM users
  financeRole                    FinanceRole?             // Finance module role (optional)
  name                           String?
  phone                          String?
  shortForm                      String?                  @db.VarChar(5) // User short form for offer IDs
  zoneId                         String?
  createdAt                      DateTime                 @default(now())
  updatedAt                      DateTime                 @updatedAt
  lastLoginAt                    DateTime?
  isActive                       Boolean                  @default(true)
  refreshToken                   String?                  @db.Text
  refreshTokenExpires            DateTime?
  tokenVersion                   String                   @db.VarChar(36)
  customerId                     Int?
  otp                            String?                  @unique
  otpExpiresAt                   DateTime?
  failedLoginAttempts            Int                      @default(0)
  accountLockedUntil             DateTime?
  lastFailedLogin                DateTime?
  lastPasswordChange             DateTime?                @default(now())
  passwordResetToken             String?                  @unique
  passwordResetExpires           DateTime?
  lastActiveAt                   DateTime?
  ipAddress                      String?
  userAgent                      String?
  attachments                    Attachment[]             @relation("UserAttachments")
  attendance                     Attendance[]             @relation("UserAttendance")
  auditLogs                      AuditLog[]               @relation("UserAuditLogs")
  AuditLog_AuditLog_userIdToUser AuditLog[]               @relation("AuditLog_userIdToUser")
  comments                       Comment[]                @relation("UserComments")
  createdCustomers               Customer[]               @relation("CustomerCreatedBy")
  updatedCustomers               Customer[]               @relation("CustomerUpdatedBy")
  activityLogs                   DailyActivityLog[]       @relation("UserActivityLogs")
  notifications                  Notification[]
  onsiteVisitLogs                OnsiteVisitLog[]         @relation("UserOnsiteVisitLogs")
  approvedPOs                    PORequest[]              @relation("ApprovedPOs")
  requestedPOs                   PORequest[]              @relation("RequestedPOs")
  serviceZones                   ServicePersonZone[]      @relation("UserServiceZones")
  assignedTickets                Ticket[]                 @relation("AssignedTickets")
  createdTickets                 Ticket[]                 @relation("TicketCreator")
  ownedTickets                   Ticket[]                 @relation("TicketOwner")
  subOwnedTickets                Ticket[]                 @relation("TicketSubOwner")
  submittedFeedbacks             TicketFeedback[]         @relation("SubmittedFeedbacks")
  ticketNotes                    TicketNote[]             @relation("UserTicketNotes")
  ticketReports                  TicketReport[]           @relation("UserTicketReports")
  statusHistoryChanges           TicketStatusHistory[]    @relation("UserStatusChanges")
  customer                       Customer?                @relation("UserCustomer", fields: [customerId], references: [id])
  
  // Offer Funnel Relations
  createdOffers                   Offer[]                  @relation("OfferCreatedBy")
  updatedOffers                   Offer[]                  @relation("OfferUpdatedBy")
  assignedOffers                  Offer[]                  @relation("OfferAssignedTo")
  createdSpareParts               SparePart[]              @relation("SparePartCreatedBy")
  updatedSpareParts               SparePart[]              @relation("SparePartUpdatedBy")
  userTargets                     UserTarget[]             @relation("UserTargets")
  createdZoneTargets              ZoneTarget[]             @relation("ZoneTargetCreatedBy")
  updatedZoneTargets              ZoneTarget[]             @relation("ZoneTargetUpdatedBy")
  createdUserTargets              UserTarget[]             @relation("UserTargetCreatedBy")
  updatedUserTargets              UserTarget[]             @relation("UserTargetUpdatedBy")
  stageRemarks                    StageRemark[]            @relation("StageRemarkCreatedBy")
  arInvoiceRemarks                ARInvoiceRemark[]        @relation("ARInvoiceRemarkCreatedBy")
  
  // Activity Scheduling Relations
  scheduledActivities             ActivitySchedule[]       @relation("ScheduledActivities")
  createdSchedules                ActivitySchedule[]       @relation("CreatedSchedules")
  
  bankAccountAttachments          BankAccountAttachment[]  @relation("UserBankAccountAttachments")

  @@index([role])
  @@index([isActive])
  @@index([role, isActive])
  @@index([customerId])
  @@index([email, isActive])
}

model Customer {
  id            Int         @id @default(autoincrement())
  companyName   String
  address       String?
  industry      String?
  timezone      String      @default("UTC")
  serviceZoneId Int
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdById   Int
  updatedById   Int
  assets        Asset[]     @relation("CustomerAssets")
  contacts      Contact[]   @relation("CustomerContacts")
  createdBy     User        @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  serviceZone   ServiceZone @relation(fields: [serviceZoneId], references: [id])
  updatedBy     User        @relation("CustomerUpdatedBy", fields: [updatedById], references: [id])
  ratings       Rating[]    @relation("CustomerRatings")
  tickets       Ticket[]    @relation("CustomerTickets")
  users         User[]      @relation("UserCustomer")
  offers        Offer[]     @relation("CustomerOffers")
  activitySchedules ActivitySchedule[] @relation("CustomerActivitySchedules")
}

model Contact {
  id                Int         @id @default(autoincrement())
  name              String
  contactPersonName String?     // For Offer Funnel compatibility
  email             String?
  phone             String
  contactNumber     String?     // Alias for phone for Offer Funnel compatibility
  role              ContactRole @default(CONTACT)
  isActive          Boolean     @default(true) // For Offer Funnel compatibility
  customerId        Int
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  passwordHash      String?
  customer          Customer    @relation("CustomerContacts", fields: [customerId], references: [id])
  tickets           Ticket[]    @relation("ContactTickets")
  offers            Offer[]     @relation("ContactOffers")

  @@index([customerId])
  @@index([email])
}

model ServiceZone {
  id             Int                 @id @default(autoincrement())
  name           String
  shortForm      String              @default("X") @db.VarChar(3) // Zone abbreviation for offer IDs
  description    String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  customers      Customer[]
  servicePersons ServicePersonZone[] @relation("ServiceZonePersons")
  tickets        Ticket[]            @relation("TicketZone")
  offers         Offer[]             @relation("OfferZone")
  zoneTargets    ZoneTarget[]        @relation("ZoneTargets")
  activitySchedules ActivitySchedule[] @relation("ZoneActivitySchedules")
}

model ServicePersonZone {
  userId        Int
  serviceZoneId Int
  serviceZone   ServiceZone @relation("ServiceZonePersons", fields: [serviceZoneId], references: [id])
  user          User        @relation("UserServiceZones", fields: [userId], references: [id])

  @@id([userId, serviceZoneId])
}

model Asset {
  id             Int              @id @default(autoincrement())
  machineId      String           @unique
  model          String?
  serialNo       String?          @unique
  location       String?
  status         String           @default("ACTIVE")
  customerId     Int
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  customer       Customer         @relation("CustomerAssets", fields: [customerId], references: [id])
  tickets        Ticket[]         @relation("AssetTickets")
  offerAssets    OfferAsset[]     @relation("AssetToOffers")

  @@index([customerId])
  @@index([status])
}

model Ticket {
  id                      Int                   @id @default(autoincrement())
  ticketNumber            Int?                  @unique // User-facing ticket number starting from 1001
  title                   String
  description             String
  status                  TicketStatus          @default(OPEN)
  priority                Priority              @default(MEDIUM)
  slaDueAt                DateTime?
  slaStatus               SLAStatus?
  customerId              Int
  contactId               Int
  assetId                 Int
  ownerId                 Int
  subOwnerId              Int?
  createdById             Int
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  assignedToId            Int?
  actualResolutionTime    Int?
  dueDate                 DateTime?
  errorDetails            String?
  escalatedAt             DateTime?
  escalatedBy             Int?
  escalatedReason         String?
  estimatedResolutionTime Int?
  isCritical              Boolean               @default(false)
  isEscalated             Boolean               @default(false)
  lastStatusChange        DateTime?             @default(now())
  poApprovedAt            DateTime?
  poApprovedById          Int?
  poNumber                String?
  proofImages             String?
  relatedMachineIds       String?
  resolutionSummary       String?
  sparePartsDetails       String?
  timeInStatus            Int?
  totalTimeOpen           Int?
  visitCompletedDate      DateTime?
  visitPlannedDate        DateTime?
  zoneId                  Int
  onsiteEndLocation       String?
  onsiteLocationHistory   String?
  onsiteStartLocation     String?
  poReachedAt             DateTime?
  visitInProgressAt       DateTime?
  visitReachedAt          DateTime?
  visitResolvedAt         DateTime?
  visitStartedAt          DateTime?
  callType                CallType?
  // Assignment Acceptance
  assignmentStatus        AssignmentStatus?     @default(PENDING)
  assignmentRespondedAt   DateTime?
  assignmentNotes         String?
  attachments             Attachment[]          @relation("TicketAttachments")
  auditLogs               AuditLog[]            @relation("TicketAuditLogs")
  comments                Comment[]             @relation("TicketComments")
  activityLogs            DailyActivityLog[]    @relation("TicketActivityLogs")
  onsiteVisitLogs         OnsiteVisitLog[]      @relation("TicketOnsiteVisitLogs")
  poRequests              PORequest?            @relation("TicketPORequests")
  rating                  Rating?               @relation("TicketRating")
  asset                   Asset                 @relation("AssetTickets", fields: [assetId], references: [id])
  assignedTo              User?                 @relation("AssignedTickets", fields: [assignedToId], references: [id])
  contact                 Contact               @relation("ContactTickets", fields: [contactId], references: [id])
  createdBy               User                  @relation("TicketCreator", fields: [createdById], references: [id])
  customer                Customer              @relation("CustomerTickets", fields: [customerId], references: [id])
  owner                   User                  @relation("TicketOwner", fields: [ownerId], references: [id])
  subOwner                User?                 @relation("TicketSubOwner", fields: [subOwnerId], references: [id])
  zone                    ServiceZone           @relation("TicketZone", fields: [zoneId], references: [id])
  feedbacks               TicketFeedback[]
  notes                   TicketNote[]          @relation("TicketNotes")
  reports                 TicketReport[]        @relation("TicketReports")
  statusHistory           TicketStatusHistory[] @relation("TicketStatusHistory")
  scheduledActivities     ActivitySchedule[]    @relation("ScheduledTickets")

  @@index([status, assignedToId])
  @@index([customerId, status])
  @@index([zoneId, status])
  @@index([assignedToId, status])
  @@index([priority, status])
  @@index([createdAt])
  @@index([status])
}

model Attachment {
  id           Int      @id @default(autoincrement())
  filename     String
  path         String
  mimeType     String
  size         Int
  ticketId     Int
  uploadedById Int
  createdAt    DateTime @default(now())
  ticket       Ticket   @relation("TicketAttachments", fields: [ticketId], references: [id])
  uploadedBy   User     @relation("UserAttachments", fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@index([uploadedById])
}

model TicketNote {
  id        Int      @id @default(autoincrement())
  content   String
  ticketId  Int
  authorId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("UserTicketNotes", fields: [authorId], references: [id])
  ticket    Ticket   @relation("TicketNotes", fields: [ticketId], references: [id])
}

model PORequest {
  id            Int       @id @default(autoincrement())
  ticketId      Int       @unique
  status        String    @default("PENDING")
  amount        Float?
  description   String?
  requestedById Int
  approvedById  Int?
  approvedAt    DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  approvedBy    User?     @relation("ApprovedPOs", fields: [approvedById], references: [id])
  requestedBy   User      @relation("RequestedPOs", fields: [requestedById], references: [id])
  ticket        Ticket    @relation("TicketPORequests", fields: [ticketId], references: [id])
}

model AuditLog {
  id                         Int      @id @default(autoincrement())
  action                     String
  details                    Json?
  entityType                 String?
  entityId                   Int?
  userId                     Int?
  ipAddress                  String?
  userAgent                  String?
  status                     String?
  metadata                   Json?
  oldValue                   Json?
  newValue                   Json?
  ticketId                   Int?
  performedById              Int?
  performedAt                DateTime @default(now())
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime
  module                     String?  // 'FSM', 'TICKET', 'OFFER', 'SYSTEM' - for filtering
  deviceInfo                 String?  // Parsed browser/OS info for login tracking
  performedBy                User?    @relation("UserAuditLogs", fields: [performedById], references: [id])
  ticket                     Ticket?  @relation("TicketAuditLogs", fields: [ticketId], references: [id], onDelete: Cascade)
  User_AuditLog_userIdToUser User?    @relation("AuditLog_userIdToUser", fields: [userId], references: [id])
  offer                      Offer?   @relation("OfferAuditLogs", fields: [offerId], references: [id])
  offerId                    Int?     // Direct reference to offer for easier querying

  @@index([performedById])
  @@index([performedAt])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId], map: "AuditLog_entity_idx")
  @@index([ticketId])
  @@index([userId])
  @@index([offerId])
  @@index([module])
}

model TicketFeedback {
  id            Int      @id @default(autoincrement())
  ticketId      Int
  rating        Int      @default(5)
  feedback      String?
  submittedById Int
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
  submittedBy   User     @relation("SubmittedFeedbacks", fields: [submittedById], references: [id])
  ticket        Ticket   @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([submittedById])
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ticketId   Int
  userId     Int
  ticket     Ticket   @relation("TicketComments", fields: [ticketId], references: [id], onDelete: Cascade)
  user       User     @relation("UserComments", fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
}

model TicketStatusHistory {
  id              Int          @id @default(autoincrement())
  ticketId        Int
  status          TicketStatus
  changedById     Int
  changedAt       DateTime     @default(now())
  notes           String?
  timeInStatus    Int?
  totalTimeOpen   Int?
  location        String?      // Location where status change occurred
  latitude        Float?       // GPS latitude
  longitude       Float?       // GPS longitude
  accuracy        Float?       // GPS accuracy in meters
  locationSource  String?      // 'gps' | 'manual' | 'network'
  changedBy       User         @relation("UserStatusChanges", fields: [changedById], references: [id])
  ticket          Ticket       @relation("TicketStatusHistory", fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([changedById])
  @@index([changedAt])
  @@index([status])
}

model Rating {
  id            Int      @id @default(autoincrement())
  ticketId      Int      @unique
  customerId    Int
  rating        Int      @db.SmallInt
  feedback      String?
  customerPhone String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  source        String   @default("WEB")
  customer      Customer @relation("CustomerRatings", fields: [customerId], references: [id], onDelete: Cascade)
  ticket        Ticket   @relation("TicketRating", fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([rating])
  @@index([createdAt])
  @@index([source])
}

model TicketReport {
  id           Int      @id @default(autoincrement())
  ticketId     Int
  fileName     String
  fileSize     Int
  fileType     String
  filePath     String
  uploadedById Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ticket       Ticket   @relation("TicketReports", fields: [ticketId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation("UserTicketReports", fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@index([uploadedById])
  @@index([createdAt])
}

model OnsiteVisitLog {
  id        Int              @id @default(autoincrement())
  ticketId  Int
  userId    Int
  event     OnsiteVisitEvent
  latitude  Decimal          @db.Decimal(10, 7)
  longitude Decimal          @db.Decimal(10, 7)
  address   String?
  createdAt DateTime         @default(now())
  ticket    Ticket           @relation("TicketOnsiteVisitLogs", fields: [ticketId], references: [id], onDelete: Cascade)
  user      User             @relation("UserOnsiteVisitLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId, event, createdAt])
  @@index([userId, createdAt])
}

model Attendance {
  id                Int              @id @default(autoincrement())
  userId            Int
  checkInAt         DateTime
  checkOutAt        DateTime?
  checkInLatitude   Decimal?         @db.Decimal(10, 7)
  checkInLongitude  Decimal?         @db.Decimal(10, 7)
  checkInAddress    String?
  checkOutLatitude  Decimal?         @db.Decimal(10, 7)
  checkOutLongitude Decimal?         @db.Decimal(10, 7)
  checkOutAddress   String?
  totalHours        Decimal?         @db.Decimal(4, 2)
  status            AttendanceStatus @default(CHECKED_IN)
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation("UserAttendance", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, checkInAt])
  @@index([status])
}

model DailyActivityLog {
  id            Int              @id @default(autoincrement())
  userId        Int
  ticketId      Int?
  activityType  ActivityType
  title         String?
  description   String?
  startTime     DateTime
  endTime       DateTime?
  duration      Int?
  location      String?
  latitude      Decimal?         @db.Decimal(10, 7)
  longitude     Decimal?         @db.Decimal(10, 7)
  metadata      Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  ActivityStage ActivityStage[]
  ticket        Ticket?          @relation("TicketActivityLogs", fields: [ticketId], references: [id], onDelete: Cascade)
  user          User             @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
  @@index([ticketId])
  @@index([activityType])
}

model ActivitySchedule {
  id                Int              @id @default(autoincrement())
  servicePersonId   Int
  servicePerson     User             @relation("ScheduledActivities", fields: [servicePersonId], references: [id], onDelete: Cascade)
  scheduledById      Int
  scheduledBy       User             @relation("CreatedSchedules", fields: [scheduledById], references: [id])
  
  // Activity Details
  description       String?
  activityType      ActivityType
  priority          SchedulePriority @default(MEDIUM)
  
  // Scheduling
  scheduledDate     DateTime
  estimatedDuration Float?           // Duration in hours
  location          String?
  
  // Status
  status            ScheduleStatus   @default(PENDING)
  acceptedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?
  completedAt       DateTime?
  
  // Relations
  ticketId          Int?
  ticket            Ticket?          @relation("ScheduledTickets", fields: [ticketId], references: [id], onDelete: SetNull)
  zoneId            Int?
  zone              ServiceZone?     @relation("ZoneActivitySchedules", fields: [zoneId], references: [id], onDelete: SetNull)
  customerId        Int?
  customer          Customer?        @relation("CustomerActivitySchedules", fields: [customerId], references: [id], onDelete: SetNull)
  
  // Assets (multiple assets can be associated)
  assetIds          Json?            // Array of asset IDs
  
  // Metadata
  notes             String?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([servicePersonId, scheduledDate])
  @@index([scheduledById])
  @@index([status])
  @@index([scheduledDate])
  @@index([ticketId])
}

model ActivityStage {
  id               Int              @id @default(autoincrement())
  activityId       Int
  stage            StageType
  startTime        DateTime
  endTime          DateTime?
  duration         Int?
  location         String?
  latitude         Decimal?         @db.Decimal(10, 7)
  longitude        Decimal?         @db.Decimal(10, 7)
  notes            String?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  DailyActivityLog DailyActivityLog @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId, startTime])
  @@index([stage])
}

// Offer Funnel Models
model Offer {
  id                    Int              @id @default(autoincrement())
  
  // Basic Information
  offerReferenceNumber  String           @unique // offer reference number
  offerReferenceDate    DateTime?        // offer reference date
  title                 String?
  description           String?
  productType           ProductType?     // product type
  lead                  LeadStatus?      // lead
  
  // Customer Information (duplicated for easy access)
  registrationDate      DateTime?        // reg date
  company               String?          // company
  location              String?          // location
  department            String?          // department
  
  // Contact Information (duplicated for easy access)
  contactPersonName     String?          // contact person name
  contactNumber         String?          // contact number
  email                 String?          // email
  
  // Asset Information (duplicated for easy access)
  machineSerialNumber   String?          // machine serial number
  
  // Status & Progress
  status                OfferStatus      @default(OPEN)
  stage                 OfferStage       @default(INITIAL)
  priority              Priority         @default(MEDIUM)
  
  // Customer & Contact
  customerId            Int
  contactId             Int
  
  // Financial Information
  offerValue            Decimal?         @db.Decimal(12, 2) // Updated field name as per your requirement
  offerMonth            String?          // Added as per your requirement (format: "YYYY-MM")
  poExpectedMonth       String?          // Added as per your requirement (format: "YYYY-MM")
  probabilityPercentage Int?             @db.SmallInt // Added as per your requirement (0-100)
  
  // PO Information
  poNumber              String?          // Added as per your requirement
  poDate                DateTime?        // Added as per your requirement
  poValue               Decimal?         @db.Decimal(12, 2) // Added as per your requirement
  poReceivedMonth       String?          // Added as per your requirement (format: "YYYY-MM")
  
  // Business Information
  openFunnel            Boolean          @default(true) // Added as per your requirement
  remarks               String?          // Added as per your requirement
  
  // System Dates
  bookingDateInSap      DateTime?        // Added as per your requirement
  offerEnteredInCrm     DateTime?        // Added as per your requirement
  offerClosedInCrm      DateTime?        // Added as per your requirement
  
  // Assignment
  zoneId                Int
  assignedToId          Int?
  
  // Tracking
  createdById           Int
  updatedById           Int
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  customer              Customer         @relation("CustomerOffers", fields: [customerId], references: [id])
  contact               Contact          @relation("ContactOffers", fields: [contactId], references: [id])
  zone                  ServiceZone     @relation("OfferZone", fields: [zoneId], references: [id])
  assignedTo            User?            @relation("OfferAssignedTo", fields: [assignedToId], references: [id])
  createdBy             User             @relation("OfferCreatedBy", fields: [createdById], references: [id])
  updatedBy             User             @relation("OfferUpdatedBy", fields: [updatedById], references: [id])
  
  // Many-to-many relationship with assets
  offerAssets           OfferAsset[]     @relation("OfferToAssets")
  // Many-to-many relationship with spare parts
  offerSpareParts       OfferSparePart[] @relation("OfferToSpareParts")
  auditLogs             AuditLog[]       @relation("OfferAuditLogs")
  stageRemarks          StageRemark[]    @relation("OfferStageRemarks")
  
  @@index([customerId])
  @@index([zoneId])
  @@index([status])
  @@index([stage])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([offerReferenceNumber])
  @@index([poNumber])
  @@index([zoneId, stage]) // Composite index for zone-wise performance queries
  @@index([createdById, createdAt]) // Composite index for user performance queries
  @@index([customerId, stage]) // Composite index for customer performance queries
  @@index([productType])
}

// Junction table for Offer-Asset many-to-many relationship
model OfferAsset {
  id        Int      @id @default(autoincrement())
  offerId   Int
  assetId   Int
  createdAt DateTime @default(now())
  
  // Relations
  offer     Offer    @relation("OfferToAssets", fields: [offerId], references: [id], onDelete: Cascade)
  asset     Asset    @relation("AssetToOffers", fields: [assetId], references: [id], onDelete: Cascade)
  
  @@unique([offerId, assetId])
  @@index([offerId])
  @@index([assetId])
}

// Stage-wise remarks tracking for offers
model StageRemark {
  id          Int         @id @default(autoincrement())
  offerId     Int
  stage       OfferStage  // The stage when this remark was added
  remarks     String      // The remark content
  createdById Int
  createdAt   DateTime    @default(now())
  
  // Relations
  offer       Offer       @relation("OfferStageRemarks", fields: [offerId], references: [id], onDelete: Cascade)
  createdBy   User        @relation("StageRemarkCreatedBy", fields: [createdById], references: [id])
  
  @@index([offerId])
  @@index([stage])
  @@index([createdAt])
}

// Spare Parts model for SSP product type
model SparePart {
  id              Int               @id @default(autoincrement())
  name            String            // Spare part name
  partNumber      String            @unique // Unique part number
  description     String?           // Description of the spare part
  category        String?           // Category (e.g., "Hardware", "Software", "Consumables")
  basePrice       Decimal           @db.Decimal(10, 2) // Base price in INR
  imageUrl        String?           // URL to spare part image
  specifications  String?           // JSON string for technical specifications
  status          SparePartStatus   @default(ACTIVE)
  
  // Tracking
  createdById     Int
  updatedById     Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  createdBy       User              @relation("SparePartCreatedBy", fields: [createdById], references: [id])
  updatedBy       User              @relation("SparePartUpdatedBy", fields: [updatedById], references: [id])
  offerSpareParts OfferSparePart[]  @relation("SparePartToOffers")
  
  @@index([partNumber])
  @@index([category])
  @@index([status])
  @@index([name])
}

// Junction table for Offer-SparePart relationship with custom pricing
model OfferSparePart {
  id          Int       @id @default(autoincrement())
  offerId     Int
  sparePartId Int
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2) // Custom price for this offer (can override base price)
  totalPrice  Decimal   @db.Decimal(10, 2) // quantity * unitPrice
  notes       String?   // Any specific notes for this spare part in this offer
  createdAt   DateTime  @default(now())
  
  // Relations
  offer       Offer     @relation("OfferToSpareParts", fields: [offerId], references: [id], onDelete: Cascade)
  sparePart   SparePart @relation("SparePartToOffers", fields: [sparePartId], references: [id], onDelete: Cascade)
  
  @@unique([offerId, sparePartId])
  @@index([offerId])
  @@index([sparePartId])
}

// Target Management Models for Director/Admin
model ZoneTarget {
  id                 Int          @id @default(autoincrement())
  serviceZoneId      Int
  targetPeriod       String       // Format: "YYYY-MM" for monthly or "YYYY" for yearly
  periodType         PeriodType   @default(MONTHLY)
  productType        ProductType? // Optional: target for specific product type
  targetValue        Decimal      @db.Decimal(12, 2) // Target revenue value
  targetOfferCount   Int?         // Target number of offers (optional)
  createdById        Int
  updatedById        Int
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  
  serviceZone        ServiceZone  @relation("ZoneTargets", fields: [serviceZoneId], references: [id])
  createdBy          User         @relation("ZoneTargetCreatedBy", fields: [createdById], references: [id])
  updatedBy          User         @relation("ZoneTargetUpdatedBy", fields: [updatedById], references: [id])
  
  @@unique([serviceZoneId, targetPeriod, periodType, productType])
  @@index([serviceZoneId])
  @@index([targetPeriod])
  @@index([productType])
}

model UserTarget {
  id                 Int          @id @default(autoincrement())
  userId             Int
  targetPeriod       String       // Format: "YYYY-MM" for monthly or "YYYY" for yearly
  periodType         PeriodType   @default(MONTHLY)
  productType        ProductType? // Optional: target for specific product type
  targetValue        Decimal      @db.Decimal(12, 2) // Target revenue value
  targetOfferCount   Int?         // Target number of offers (optional)
  createdById        Int
  updatedById        Int
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  
  user               User         @relation("UserTargets", fields: [userId], references: [id])
  createdBy          User         @relation("UserTargetCreatedBy", fields: [createdById], references: [id])
  updatedBy          User         @relation("UserTargetUpdatedBy", fields: [updatedById], references: [id])
  
  @@unique([userId, targetPeriod, periodType, productType])
  @@index([userId])
  @@index([targetPeriod])
  @@index([productType])
}

enum LeadStatus {
  YES
  NO
}

enum UserRole {
  ADMIN
  ZONE_MANAGER
  ZONE_USER
  SERVICE_PERSON
  EXTERNAL_USER
  EXPERT_HELPDESK
}

// Finance Module Roles
enum FinanceRole {
  FINANCE_ADMIN
  FINANCE_USER
  FINANCE_VIEWER
}

enum ContactRole {
  ACCOUNT_OWNER
  CONTACT
}

enum TicketStatus {
  OPEN
  ASSIGNED
  IN_PROCESS
  WAITING_CUSTOMER
  CLOSED_PENDING
  CLOSED
  ONSITE_VISIT
  ONSITE_VISIT_PLANNED
  RESOLVED
  SPARE_PARTS_NEEDED
  SPARE_PARTS_BOOKED
  SPARE_PARTS_DELIVERED
  PENDING
  IN_PROGRESS
  ON_HOLD
  ESCALATED
  PO_NEEDED
  PO_RECEIVED
  CANCELLED
  REOPENED
  ONSITE_VISIT_STARTED
  ONSITE_VISIT_REACHED
  ONSITE_VISIT_IN_PROGRESS
  ONSITE_VISIT_RESOLVED
  ONSITE_VISIT_PENDING
  ONSITE_VISIT_COMPLETED
  PO_REACHED
}

enum SLAStatus {
  ON_TIME
  AT_RISK
  BREACHED
  NOT_APPLICABLE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CallType {
  UNDER_MAINTENANCE_CONTRACT
  NOT_UNDER_CONTRACT
}

enum NotificationType {
  TICKET_CREATED
  TICKET_UPDATED
  TICKET_COMMENT
  TICKET_ASSIGNED
  PO_CREATED
  PO_UPDATED
  PO_APPROVAL
  SYSTEM_ALERT
  MAINTENANCE
  OTHER
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum OnsiteVisitEvent {
  STARTED
  REACHED
  ENDED
  REACHED_BACK
  WORK_STARTED
  WORK_PAUSED
  WORK_RESUMED
  WORK_COMPLETED
  RESOLVED
  PENDING
}

enum AttendanceStatus {
  CHECKED_IN
  CHECKED_OUT
  ABSENT
  LATE
  EARLY_CHECKOUT
}

enum ActivityType {
  TICKET_WORK
  BD_VISIT
  PO_DISCUSSION
  SPARE_REPLACEMENT
  TRAVEL
  TRAINING
  MEETING
  MAINTENANCE
  DOCUMENTATION
  OTHER
  WORK_FROM_HOME
  INSTALLATION
  MAINTENANCE_PLANNED
  REVIEW_MEETING
  RELOCATION
}

enum StageType {
  STARTED
  TRAVELING
  ARRIVED
  WORK_IN_PROGRESS
  COMPLETED
  ASSESSMENT
  PLANNING
  EXECUTION
  TESTING
  DOCUMENTATION
  CUSTOMER_HANDOVER
  PREPARATION
  CLEANUP
}

enum ScheduleStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  CANCELLED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum SchedulePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ReportType {
  COMPLETION
  CLOSURE
  SUMMARY
}

// Offer Funnel Enums
enum OfferStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  QUOTED
  NEGOTIATION
  WON
  LOST
  ON_HOLD
  CANCELLED
}

enum OfferStage {
  INITIAL
  PROPOSAL_SENT
  NEGOTIATION
  PO_RECEIVED
  WON
  LOST
}

enum ProductType {
  RELOCATION
  CONTRACT
  SPP
  UPGRADE_KIT
  SOFTWARE
  BD_CHARGES
  BD_SPARE
  MIDLIFE_UPGRADE
  RETROFIT_KIT
}

enum PeriodType {
  MONTHLY
  YEARLY
}

enum SparePartStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

// ═══════════════════════════════════════════════════════════════════════════
// AR (ACCOUNTS RECEIVABLE) MODULE - Finance
// Simplified schema matching Excel structure exactly
// ═══════════════════════════════════════════════════════════════════════════

enum ARRiskClass {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ARInvoiceStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum ARDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  ACKNOWLEDGED
}

// Invoice Type for distinguishing regular vs prepaid invoices
enum ARInvoiceType {
  REGULAR
  PREPAID
}

// Prepaid Invoice Status - tracks delivery against prepayment
enum ARPrepaidStatus {
  AWAITING_DELIVERY    // Payment received, delivery pending
  PARTIALLY_DELIVERED  // Some items delivered
  FULLY_DELIVERED      // All items delivered
  EXPIRED              // Prepaid period expired without delivery
}

// AR Payment Terms Master
model ARPaymentTerms {
  id          String   @id @default(uuid())
  termCode    String   @unique
  termName    String
  dueDays     Int
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ar_payment_terms_master")
}

// AR Invoice - Simplified table with SAP mandatory fields + manual tracking
model ARInvoice {
  id                  String            @id @default(uuid())
  
  // ═══════════════════════════════════════════════════════════════════════════
  // SAP FIELDS (Mandatory - Green columns from SAP Excel)
  // ═══════════════════════════════════════════════════════════════════════════
  invoiceNumber       String    @unique // Doc. No. (A)
  bpCode              String            // Customer Code (C)
  customerName        String            // Customer Name (D)
  poNo                String?           // Customer Ref. No. (F)
  totalAmount         Decimal   @db.Decimal(15, 2) // Amount (H)
  netAmount           Decimal   @db.Decimal(15, 2) // Net / Invoice Amount (I)
  taxAmount           Decimal?  @db.Decimal(15, 2) // Tax (J)
  invoiceDate         DateTime          // Document Date (M)
  
  // ═══════════════════════════════════════════════════════════════════════════
  // PAYMENT TERMS & CALCULATIONS
  // ═══════════════════════════════════════════════════════════════════════════
  dueDate             DateTime          // Due Date (from Payment Terms)
  actualPaymentTerms  String?           // Actual Payment Terms
  balance             Decimal?  @db.Decimal(15, 2) // Balance = TotalAmount - TotalReceipts
  riskClass           ARRiskClass @default(LOW)   // Risk Class (Calculated)
  dueByDays           Int?              // Due by Days (Calculated)
  
  // ═══════════════════════════════════════════════════════════════════════════
  // CUSTOMER MASTER FIELDS (Mandatory: Email ID)
  // ═══════════════════════════════════════════════════════════════════════════
  emailId             String?           // Email ID (Mandatory - Cust. Master)
  contactNo           String?           // Contact No. (Cust. Master)
  region              String?           // Region (Cust. Master)
  department          String?           // Department (Cust. Master)
  personInCharge      String?           // Person In-charge (Cust. Master)
  pocName             String?           // POC Name (Cust. Master)
  
  // ═══════════════════════════════════════════════════════════════════════════
  // MANUAL TRACKING FIELDS
  // ═══════════════════════════════════════════════════════════════════════════
  receipts            Decimal?  @db.Decimal(15, 2) // Receipts (Manual)
  adjustments         Decimal?  @db.Decimal(15, 2) // Adjustments (Manual)
  totalReceipts       Decimal?  @db.Decimal(15, 2) // Total Receipts = Receipts + Adjustments
  type                String?           // Type (TBC)
  modeOfDelivery      String?           // Mode of Delivery with Details
  sentHandoverDate    DateTime?         // Sent/Handover date
  deliveryStatus      ARDeliveryStatus @default(PENDING) // Delivered/Acknowledgement Status (Mandatory)
  impactDate          DateTime?         // Acceptance/GRN/Delivered/Acknowledgement date
  comments            String?           // Comments/Remarks
  
  // ═══════════════════════════════════════════════════════════════════════════
  // SYSTEM FIELDS
  // ═══════════════════════════════════════════════════════════════════════════
  status              ARInvoiceStatus @default(PENDING)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // ═══════════════════════════════════════════════════════════════════════════
  // INVOICE TYPE & PREPAID FIELDS
  // ═══════════════════════════════════════════════════════════════════════════
  invoiceType         ARInvoiceType @default(REGULAR) // REGULAR, PREPAID, CREDIT_NOTE
  advanceReceivedDate DateTime?     // When prepayment was received (for prepaid)
  deliveryDueDate     DateTime?     // Expected delivery date (for prepaid)
  prepaidStatus       ARPrepaidStatus? // Status for prepaid invoices
  
  // Remarks relation
  remarks             ARInvoiceRemark[]

  @@index([bpCode])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@index([riskClass])
  @@index([invoiceType])
  @@map("ar_invoices")
}

// AR Invoice Remarks - Trackable comments with who/when
model ARInvoiceRemark {
  id          String   @id @default(uuid())
  invoiceId   String
  content     String   @db.Text
  createdById Int
  createdAt   DateTime @default(now())
  
  invoice     ARInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("ARInvoiceRemarkCreatedBy", fields: [createdById], references: [id])

  @@index([invoiceId])
  @@index([createdAt])
  @@map("ar_invoice_remarks")
}

// AR Import History
model ARImportHistory {
  id            String   @id @default(uuid())
  fileName      String
  recordsCount  Int
  successCount  Int
  failedCount   Int
  importedBy    String?
  importedAt    DateTime @default(now())
  status        String   @default("COMPLETED")
  errorLog      String?

  @@map("ar_import_history")
}

// AR Payment History
model ARPaymentHistory {
  id              String    @id @default(uuid())
  invoiceId       String
  amount          Decimal   @db.Decimal(15, 2)
  paymentDate     DateTime
  paymentTime     String?   // Time of payment (HH:mm format)
  paymentMode     String    // NEFT, RTGS, CHEQUE, CASH, ADJUSTMENT
  referenceNo     String?   // Cheque No, UTR No
  notes           String?
  recordedBy      String?   // User who recorded this payment
  createdAt       DateTime  @default(now())
  
  // Note: Loose relation - invoiceId references ar_invoices but not enforced
  // This allows flexibility with denormalized AR data

  @@index([invoiceId])
  @@map("ar_payment_history")
}

// AR Invoice Activity Log - Comprehensive audit trail for compliance and fraud prevention
model ARInvoiceActivityLog {
  id            String   @id @default(uuid())
  invoiceId     String
  action        String   // CREATED, UPDATED, PAYMENT_ADDED, STATUS_CHANGED, DELIVERY_UPDATED, REMARK_ADDED, DELETED
  description   String   // Human-readable description of the action
  fieldName     String?  // Field that was changed (for updates)
  oldValue      String?  // Previous value (JSON stringified if complex)
  newValue      String?  // New value (JSON stringified if complex)
  performedById Int?
  performedBy   String?  // User name (denormalized for display)
  ipAddress     String?
  userAgent     String?
  metadata      Json?    // Additional context data
  createdAt     DateTime @default(now())

  @@index([invoiceId])
  @@index([action])
  @@index([createdAt])
  @@index([performedById])
  @@map("ar_invoice_activity_logs")
}

// AR Session Activity Log - Track login/logout events for audit trail
model ARSessionActivityLog {
  id            String   @id @default(uuid())
  action        String   // LOGIN, LOGOUT, LOGIN_FAILED, SESSION_EXPIRED, PASSWORD_RESET
  userId        Int?
  userName      String?  // Denormalized for display
  userEmail     String?
  userRole      String?  // FSM role
  financeRole   String?  // Finance module role
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?  // Parsed browser/OS info
  metadata      Json?    // Additional context
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("ar_session_activity_logs")
}

// ═══════════════════════════════════════════════════════════════════════════
// BANK ACCOUNTS MODULE - Finance
// Vendor bank details management with role-based change request workflow
// ═══════════════════════════════════════════════════════════════════════════

model BankAccount {
  id                  String   @id @default(uuid())
  vendorName          String
  beneficiaryBankName String
  accountNumber       String   @unique
  ifscCode            String
  emailId             String?
  beneficiaryName     String?
  nickName            String?
  isActive            Boolean  @default(true)
  createdById         Int
  updatedById         Int
  isMSME              Boolean  @default(false)
  udyamRegNum         String?
  currency            String   @default("INR")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  changeRequests      BankAccountChangeRequest[] @relation("BankAccountRequests")
  attachments         BankAccountAttachment[]    @relation("BankAccountToAttachments")

  @@index([vendorName])
  @@index([accountNumber])
  @@index([isActive])
  @@map("bank_accounts")
}

model BankAccountChangeRequest {
  id              String   @id @default(uuid())
  bankAccountId   String?  // null for CREATE requests
  requestType     BankAccountRequestType
  status          BankAccountRequestStatus @default(PENDING)
  
  // Requested changes (JSON storing the proposed values)
  requestedData   Json
  
  // Approval tracking
  requestedById   Int
  requestedAt     DateTime @default(now())
  reviewedById    Int?
  reviewedAt      DateTime?
  reviewNotes     String?
  
  bankAccount     BankAccount? @relation("BankAccountRequests", fields: [bankAccountId], references: [id], onDelete: Cascade)
  attachments     BankAccountAttachment[] @relation("RequestToAttachments")
  
  @@index([status])
  @@index([requestedById])
  @@index([bankAccountId])
  @@map("bank_account_change_requests")
}

enum BankAccountRequestType {
  CREATE
  UPDATE
  DELETE
}

model BankAccountAttachment {
  id              String   @id @default(uuid())
  filename        String
  path            String
  mimeType        String
  size            Int
  bankAccountId   String?
  changeRequestId String?
  uploadedById    Int
  createdAt       DateTime @default(now())

  bankAccount     BankAccount? @relation("BankAccountToAttachments", fields: [bankAccountId], references: [id], onDelete: Cascade)
  changeRequest   BankAccountChangeRequest? @relation("RequestToAttachments", fields: [changeRequestId], references: [id], onDelete: Cascade)
  uploadedBy      User        @relation("UserBankAccountAttachments", fields: [uploadedById], references: [id])

  @@index([bankAccountId])
  @@index([changeRequestId])
  @@map("bank_account_attachments")
}

enum BankAccountRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
